<ion-header translucent="true">
  <ion-toolbar>
    <ion-title>Lernfeld 1: Baustellen einrichten (Gleisbau)</ion-title>
    <ion-buttons slot="end">
      <ion-button routerLink="/dashboard" fill="clear">Zur Uebersicht</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="page-shell" *ngIf="!loading && !error; else stateBlock">
    <section class="hero">
      <div>
        <p class="eyebrow">Lernfeld 1</p>
        <h1>Baustellen einrichten</h1>
        <p class="lede">
          Ziele: sicher aufbauen, Verkehrs- und Gleisbereich absichern, Ablaeufe klar machen.
          Dauer: ca. 20 Stunden. Fokus: erst sichern, dann arbeiten.
        </p>
        <div class="badges">
          <ion-chip color="primary" outline="true">Gleisbau-Spezifisch in Block 6</ion-chip>
          <ion-chip color="success" outline="true">Interaktiv: Quiz, Szenarien, Puzzle</ion-chip>
        </div>
      </div>
      <div class="progress">
        <div class="stat">
          <span>Abgeschlossene Bloecke</span>
          <strong>{{ progress.completedBlocks.length }}/{{ blocks.length }}</strong>
        </div>
        <div class="stat">
          <span>Scenario Score</span>
          <strong>{{ progress.scenarioScore }}</strong>
        </div>
        <div class="stat">
          <span>Quizfragen bearbeitet</span>
          <strong>{{ answeredQuizCount() }}/{{ quiz?.questions?.length || 0 }}</strong>
        </div>
      </div>
    </section>

    <ion-grid>
      <ion-row>
        <ion-col size="12" sizeLg="3">
          <div class="sticky-nav">
            <app-lf01-nav
              [blocks]="blocks"
              [completed]="progress.completedBlocks"
              [activeId]="selectedBlock?.id"
              (selectBlock)="selectBlock($event)"
            ></app-lf01-nav>
          </div>
        </ion-col>

        <ion-col size="12" sizeLg="9">
          <section *ngFor="let block of blocks" class="block" [attr.id]="block.id">
            <div class="block-head">
              <div>
                <p class="eyebrow">{{ block.id | uppercase }}</p>
                <h2>
                  {{ block.title }}
                  <ion-badge color="warning" *ngIf="block.title.toLowerCase().includes('gleis')">Gleisbau</ion-badge>
                </h2>
                <p class="summary">{{ block.summary }}</p>
              </div>
              <ion-button
                color="success"
                (click)="toggleCompleted(block)"
                [fill]="progress.completedBlocks.includes(block.id) ? 'solid' : 'outline'"
              >
                Erledigt
              </ion-button>
            </div>

            <app-lesson-renderer [block]="block"></app-lesson-renderer>
          </section>
        </ion-col>
      </ion-row>
    </ion-grid>

    <section class="extras overall-quiz" *ngIf="quiz">
      <h3>Grosses Gesamtquiz Lernfeld 1</h3>
      <p>
        Alle Fragen aus Lernfeld 1 in einem Durchlauf. Nach jeder Antwort siehst du direkt, ob sie richtig oder falsch war.
      </p>
      <app-quiz-engine
        [questions]="quiz.questions"
        [shuffle]="false"
        [title]="'Gesamtquiz Lernfeld 1'"
        (answered)="quizAnswered($event)"
      ></app-quiz-engine>
    </section>

    <section class="extras" *ngIf="scenarios">
      <h3>Story-Szenarien: Was wuerdest du tun?</h3>
      <app-scenario-runner [scenarios]="scenarios.scenarios" (progress)="scenarioProgress($event)"></app-scenario-runner>
    </section>

    <section class="extras" *ngIf="puzzle">
      <h3>Drag & Drop Puzzle</h3>
      <app-lf01-sign-puzzle [puzzle]="puzzle"></app-lf01-sign-puzzle>
    </section>
  </div>

  <ng-template #stateBlock>
    <ion-spinner *ngIf="loading"></ion-spinner>
    <p *ngIf="error">{{ error }}</p>
  </ng-template>
</ion-content>
